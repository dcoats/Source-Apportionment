{
for (i in 1:116)    ####For some reason I usually have to run this a couple times for it to work, and running it in another for loop doesn't fix it,
{                   ####Run until there are 93 species
if (yfleet1[i]==0)
{
species<-species[-i];
yfleet1profiles<-yfleet1profiles[-i,];
yfleet1VA<-yfleet1VA[-i,];
yfleet1<-yfleet1[-i];
}
}
}
yfleet1
for(j in 1:5)
{
for (i in 1:116)    ####For some reason I usually have to run this a couple times for it to work, and running it in another for loop doesn't fix it,
{                   ####Run until there are 93 species
if (yfleet1[i]==0)
{
species<-species[-i];
yfleet1profiles<-yfleet1profiles[-i,];
yfleet1VA<-yfleet1VA[-i,];
yfleet1<-yfleet1[-i];
}
}
}
yfleet1
ysims<-matrix(NA,93,days)
#ysimsp<-matrix(NA,93,days)
ysimsunc<-matrix(NA,93,days)
#for(i in 1:93)
#{
#for(j in 1:3)
#{
#yfleet1profilesp[i,j]<-yfleet1profiles[i,j]/sum(yfleet1profiles[,j])
# }
#}
#yfleet1profilesp
cv<-.2
for (i in 1:93)  ###generating y's distributed lognormally,  profiles for fleet1 over days days
{
for(j in 1:days)
{
ysims[i,j]<-exp(rnorm(1,mean=log(yfleet1[i])-(.5*log(((cv)^2)+1)),sd=sqrt(log(((cv)^2)+1))))
# ysimsp[i,j]<-ysims[i,j]/sum(ysims[,j])
}
}
C<-as.matrix(ysims)
VC<-C*.2
A<-yfleet1profiles
VA<-yfleet1VA
EVold(C,VC,A,VA,diag(nrow(C)),update.A=FALSE,diagmat=TRUE)
warnings()
help(memory.size)
memory.limit(size=60500)
memory.limit()
memory.limit(size=8000)
setwd("C:\\Users\\David Coats\\Documents\\Research for Dr. Christensen\\Source Aportionment\\Fleets")
load("SI")
load("SIunc")
load("CI")
load("CIunc")
library(gtools)  ###This library contains functions for Dirichlet Distribution
datagen<-function(cv,cvlog)
{
### Creating gas profiles ###
gas<-SI[,4:7]
gas
gasunc<-SIunc[,4:7]
is.matrix(gas)
gas<-gas[-(121:124),]
gasdir<-rdirichlet(1,c(1,1,1,1))
for (i in 1:4)         ###converting profiles from factors to numeric data
{
gas[,i]<-as.numeric(as.character(gas[,i]))
gasunc[,i]<-as.numeric(as.character(gasunc[,i]))
gas[,i]<-gas[,i]*gasdir[1,i]
}
gasp<-matrix(NA,120,1)
for(i in 1:120)
{
gasp[i]<-sum(gas[i,])
}
### Creating smoker profiles###
smokers<-SI[,38:50]
smokers
smokerunc<-SIunc[,38:50]
is.matrix(smokers)
smokdir<-rdirichlet(1,c(1,1,1,1,1,1,1,1,1,1,1,1,1))
for (i in 1:13)               ###converting profiles from factors to numeric data
{
smokers[,i]<-as.numeric(as.character(smokers[,i]))
smokerunc[,i]<-as.numeric(as.character(smokerunc[,i]))
smokers[,i]<-smokers[,i]*smokdir[1,i]
}
smokerp<-matrix(,120,1)
for(i in 1:120)
{
smokerp[i]<-sum(smokers[i,])
}
### Creating diesel profiles###
diesel<-CI[,8:22]     ###creating profile for diesel vehicles
diesel
dieselunc<-CIunc[,8:22]
is.matrix(diesel)
dieseldir<-rdirichlet(1,c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1))
for (i in 1:15)               ###converting profiles from factors to numeric data
{
diesel[,i]<-as.numeric(as.character(diesel[,i]))
dieselunc[,i]<-as.numeric(as.character(dieselunc[,i]))
diesel[,i]<-diesel[,i]*dieseldir[1,i]
}
dieselp<-matrix(,120,1)
for(i in 1:120)
{
dieselp[i]<-sum(diesel[i,])
}
yfleet1profiles<-matrix(NA,120,3)
yfleet1profiles[,1]<-gasp
yfleet1profiles[,2]<-smokerp
yfleet1profiles[,3]<-dieselp
#species<-as.matrix(SI$X)
#species<-species[-(121:124),]
q=1
while(q <= dim(yfleet1profiles)[1])
{
if (sum(yfleet1profiles[q,])==0)
{
yfleet1profiles<-yfleet1profiles[-q,];
#species<-species[-q,];
q=q-1;
}
q=q+1
}
#yfleet1profiles
#### Producing Data###
fgas1<-vector(mode="numeric",4)
fgas<-matrix(NA,120,4)
for(g in 1:4)
{
fgas1[g]<-rnorm(1,15,sd=15*cv)
}
for(k in 1:120)
{
for(g in 1:4)
{                     ###All fgas(ji) are drawn from a normal(15,var=9) distribution
fgas[k,g]<-fgas1[g]
}
}
gasmatrix<-matrix(NA,120,4)
for(k in 1:120)
{
for(g in 1:4)
{
gasmatrix[k,g]<-gas[k,g]*fgas[k,g]
}
}
gasVAmat<-matrix(NA,4,4)
for(i in 1:4)
{
for(j in 1:4)
{
if(i != j)
{
gasVAmat[i,j]<-gasdir[1,i]*gasdir[1,j]*cov(gas[,i],gas[,j])
}
else
{
gasVAmat[i,j]<-0
}
}
}
gasprofile<-vector(mode='numeric',120)
gasVA<-vector(mode='numeric',120)
for(k in 1:120)
{
gasprofile[k]<-sum(gasmatrix[k,])
#gasVA[k]<-(1/16)*sum((gasunc[k,])^2)
#gasVA[k]<-((gasdir[1,1]^2)*gasunc[k,1])+((gasdir[1,2]^2)*gasunc[k,2])+((gasdir[1,3]^2)*gasunc[k,3])+((gasdir[1,4]^2)*gasunc[k,4])+2*gasdir[1,1]*gasdir[1,2]*cov(gas[,1],gas[,2])+2*gasdir[1,1]*gasdir[1,3]*cov(gas[,1],gas[,3])+2*gasdir[1,1]*gasdir[1,4]*cov(gas[,1],gas[,4])+2*gasdir[1,2]*gasdir[1,3]*cov(gas[,2],gas[,3])+2*gasdir[1,2]*gasdir[1,4]*cov(gas[,2],gas[,4])+2*gasdir[1,3]*gasdir[1,4]*cov(gas[,3],gas[,4])
gasVA[k]<-((gasdir[1,1]^2)*gasunc[k,1])+((gasdir[1,2]^2)*gasunc[k,2])+((gasdir[1,3]^2)*gasunc[k,3])+((gasdir[1,4]^2)*gasunc[k,4])+sum(gasVAmat)
}
fsmokers1<-vector(mode="numeric",13)
fsmokers<-matrix(NA,120,13)
for(s in 1:13)
{
fsmokers1[s]<-rnorm(1,.937,sd=.937*cv)
}
for(k in 1:120)
{
for(s in 1:13)
{                     ###All fsmokers(ji) are drawn from a normal(.937,var=.03515625) distribution
fsmokers[k,s]<-fsmokers1[s]
}
}
smokersmatrix<-matrix(NA,120,13)
for(k in 1:120)
{
for(s in 1:13)
{
smokersmatrix[k,s]<-smokers[k,s]*fsmokers[k,s]
}
}
sum(smokersmatrix[1,1:13])
smokerVAmat<-matrix(NA,13,13)
for(i in 1:13)
{
for(j in 1:13)
{
if(i != j)
{
smokerVAmat[i,j]<-smokdir[1,i]*smokdir[1,j]*cov(smokers[,i],smokers[,j])
}
else
{
smokerVAmat[i,j]<-0
}
}
}
smokerprofile<-vector(mode='numeric',120)
smokerVA<-vector(mode='numeric',120)
for(k in 1:120)
{
smokerprofile[k]<-sum(smokersmatrix[k,])
#smokerVA[k]<-((1/13)^2)*sum((smokerunc[k,])^2)
smokerVA[k]<-((smokdir[1,1]^2)*smokerunc[k,1]) + ((smokdir[1,2]^2)*smokerunc[k,2]) + ((smokdir[1,3]^2)*smokerunc[k,3]) + ((smokdir[1,4]^2)*smokerunc[k,4]) + ((smokdir[1,5]^2)*smokerunc[k,5]) + ((smokdir[1,6]^2)*smokerunc[k,6])
+ ((smokdir[1,7]^2)*smokerunc[k,7]) + ((smokdir[1,8]^2)*smokerunc[k,8]) + ((smokdir[1,9]^2)*smokerunc[k,9]) + ((smokdir[1,10]^2)*smokerunc[k,10]) + ((smokdir[1,11]^2)*smokerunc[k,11]) + ((smokdir[1,12]^2)*smokerunc[k,12]) + ((smokdir[1,13]^2)*smokerunc[k,13])
+ sum(smokerVAmat)
}
fdiesel1<-vector(mode="numeric",15)
fdiesel<-matrix(NA,120,15)
for(d in 1:15)
{
fdiesel1[d]<-rnorm(1,2.8125,sd=2.8125*cv)
}
for(k in 1:120)
{
for(d in 1:15)
{                     ###All fdiesel(ji) are drawn from a normal(2.8125,var=.3164) distribution
fdiesel[k,d]<-fdiesel1[d]
}
}
dieselmatrix<-matrix(NA,120,15)
for(k in 1:120)
{
for(d in 1:15)
{
dieselmatrix[k,d]<-diesel[k,d]*fdiesel[k,d]
}
}
dieselVAmat<-matrix(NA,15,15)
for(i in 1:15)
{
for(j in 1:15)
{
if(i != j)
{
dieselVAmat[i,j]<-dieseldir[1,i]*dieseldir[1,j]*cov(diesel[,i],diesel[,j])
}
else
{
dieselVAmat[i,j]<-0
}
}
}
dieselsquares<-matrix(NA,120,15)
for(i in 1:15)
{
for(j in 1:120)
{
dieselsquares[j,i]<-(dieseldir[1,i]^2)*dieselunc[j,i]
}
}
dieselvar<-apply(dieselsquares,1,sum)
dieselprofile<-vector(mode='numeric',120)
dieselVA<-vector(mode='numeric',120)
for(k in 1:120)
{
dieselprofile[k]<-sum(dieselmatrix[k,])
#dieselVA[k]<-((1/15)^2)*sum((dieselunc[k,])^2)
}
dieselVA<-dieselvar+sum(dieselVAmat)
yfleet1VA<-matrix(NA,120,3)
yfleet1VA[,1]<-gasVA
yfleet1VA[,2]<-smokerVA
yfleet1VA[,3]<-dieselVA
yfleet1<-gasprofile+smokerprofile+dieselprofile
q=1
while(q <= length(yfleet1))
{
if (yfleet1[q]==0)
{
yfleet1VA<-yfleet1VA[-q,];
yfleet1<-yfleet1[-q];
q=q-1
}
q=q+1
}
ysims1<-matrix(NA,93,1)
for (i in 1:93)  ###generating y's distributed lognormally,  profiles for fleet1 over days days
{
ysims1[i,1]<-exp(rnorm(1,mean=log(yfleet1[i])-(.5*log(((cvlog)^2)+1)),sd=sqrt(log(((cvlog)^2)+1))))
}
fpre1<-matrix(NA,1,3)
fpre1[1,1]<-mean(fgas[1,])
fpre1[1,2]<-mean(fsmokers[1,])
fpre1[1,3]<-mean(fdiesel[1,])
out<-NULL
out[[1]]<-ysims1
out[[2]]<-fpre1
out[[3]]<-yfleet1profiles
out[[4]]<-yfleet1VA
return(out)
}
#datagen(cv)
days<-50
ysims<-matrix(NA,93,days)
fpre<-matrix(NA,days,3)
cv<-.05
cvlog<-.05
fleet1profilesarr<-array(NA,dim=c(93,3,days))
fleet1VAarr<-array(NA,dim=c(93,3,days))
for(i in 1:days)
{
dataday<-datagen(cv,cvlog)
fleet1profilesarr[,,i]<-dataday[[3]]
fleet1VAarr[,,i]<-dataday[[4]]
fpre[i,]<-dataday[[2]][1,]
ysims[,i]<-dataday[[1]][,1]
}
setwd("C:\\Users\\David Coats\\Documents\\Research for Dr. Christensen\\Source Aportionment\\PMFstuff\\pmf_r_interface_old")
source("jeff's functions.R")
#load(".Rdata")
pmf3<-function(cv)
{
days<-1
VC<-cv*ysimspmf
VCt<-t(VC)
ysimst<-t(ysimspmf)
write.table(ysimst,file="ysim1dat.txt",quote=F,row.names=FALSE,col.names=FALSE)
write.table(VCt,file="yVC1dat.txt",quote=F,row.names=FALSE,col.names=FALSE)
n<-1
uncertainty<-t(yfleet1VA1)
for(i in 1:3)
{
for(j in 1:93)
{
if (uncertainty[i,j]==0)
{
uncertainty[i,j]=.00001
}
}
}
uncertainty
#for(i in 1:93)
#{
#if(yfleet1profiles[i,3]==0)
#{
# yfleet1profiles[i,3]=.00001
# }
#}
i<-min(dim(yfleet1profiles1))
k<-max(dim(yfleet1profiles1))
n<-1
#runpmfplain("default_nogkey.ini",ysimst,VCt,mypaste("testfac",i,".txt"),mypaste("testlam",i,".txt"),
#mypaste("testq",i,".txt"),fpeak= 0.1,i,nrow(ysims),ncol(ysims))
#   if no gkeying is used, change "keydat" to "sldat"
#lam<-read.table(mypaste("testlam",i,".txt"))
#fac<-read.table(mypaste("testfac",i,".txt"))
gkeyprep(yfleet1profiles1,uncertainty,"yVC1dat.txt","ysim1dat.txt")     #gets ready to gkey
runpmf("default_gkey_3source.ini",mypaste("keydat",i,".txt"),mypaste("testfac",i,".txt"),mypaste("testlam",i,".txt"),
mypaste("testq",i,".txt"),i,n+i,k)                  # ini file must be set up for gkeying,
#   if no gkeying is used, change "keydat" to "sldat"
#runpmf("default_gkey_3source.ini","ysim50dat.txt",mypaste("testfac",i,".txt"),mypaste("testlam",i,".txt"),
# mypaste("testq",i,".txt"),i,n+i,k)
#runpmf2("default_gkey_6source.ini",mypaste("keydat",i,".txt"),mypaste("testfac",i,".txt"),mypaste("testlam",i,".txt"),
#mypaste("testq",i,".txt"),fpeak= -0.1,i,n+i,k)        #   if no gkeying is used, change "keydat" to "sldat"
lam<-read.table(mypaste("testlam",i,".txt"))
fac<-read.table(mypaste("testfac",i,".txt"))
fac<-fac[-c(1:i),]    #if gkeying is used
##lamplots(lam,"gkey")  #the imagemagick batch files use these names, so if they are changed the .bat files must be changed
##facplots(fac,"gkeyf","2001/6/1","2003/6/6")
##weekendplots(i,"gkeyw")
fac<-as.matrix(fac)
apply(fac/83.59759,2,mean)
apply(fac/135.25885,2,mean)
apply(fac/932.02049,2,mean)
fac1<-fac
fac1[,1]<-fac[,1]/83.59759
fac1[,2]<-fac[,2]/135.25885
fac1[,3]<-fac[,3]/932.02049
###for cv=.5
#fac1[,1]<-fac[,2]/83.59759
#fac1[,2]<-fac[,1]/135.25885
#fac1[,3]<-fac[,3]/932.02049
###
facmse<-matrix(NA,days,3)
for(i in 1:days)
{
facmse[i,1]<-(fac1[i,1]-fpre1[1])^2
facmse[i,2]<-(fac1[i,2]-fpre1[2])^2
facmse[i,3]<-(fac1[i,3]-fpre1[3])^2
}
out<-NULL
out[[1]]<-fac1
out[[2]]<-facmse
return(out)
}
cv<-.05
iter<-50
fac1<-matrix(NA,50,3)
for(t in 1:iter)
{
fpre1<-fpre[t,]
yfleet1profiles1<-fleet1profilesarr[,,t]
yfleet1VA1<-fleet1VAarr[,,t]
ysimspmf<-ysims[,t]
pmf3run<-pmf3(cv)
fac1<-pmf3run[[1]]
facmse<-pmf3run[[2]]
}
facmeans<-apply(fac1,2,mean)
facmsemeans<-apply(facmse,2,mean)
pmfsim<-matrix(NA,1,6)
colnames(pmfsim)<-c("fgas","smoker","fdiesel","msegas","msesmoker","msediesel")
for(i in 1:3)
{
pmfsim[1,i]<-facmeans[[i]]
}
pmfsim[,4]<-facmsemeans[1]
pmfsim[,5]<-facmsemeans[2]
pmfsim[,6]<-facmsemeans[3]
pmfsim
days<-500
ysims<-matrix(NA,93,days)
fpre<-matrix(NA,days,3)
cv<-.05
cvlog<-.05
fleet1profilesarr<-array(NA,dim=c(93,3,days))
fleet1VAarr<-array(NA,dim=c(93,3,days))
for(i in 1:days)
{
dataday<-datagen(cv,cvlog)
fleet1profilesarr[,,i]<-dataday[[3]]
fleet1VAarr[,,i]<-dataday[[4]]
fpre[i,]<-dataday[[2]][1,]
ysims[,i]<-dataday[[1]][,1]
}
cv<-.05
iter<-500
fac1<-matrix(NA,50,3)
for(t in 1:iter)
{
fpre1<-fpre[t,]
yfleet1profiles1<-fleet1profilesarr[,,t]
yfleet1VA1<-fleet1VAarr[,,t]
ysimspmf<-ysims[,t]
pmf3run<-pmf3(cv)
fac1<-pmf3run[[1]]
facmse<-pmf3run[[2]]
}
facmeans<-apply(fac1,2,mean)
facmsemeans<-apply(facmse,2,mean)
pmfsim<-matrix(NA,1,6)
colnames(pmfsim)<-c("fgas","smoker","fdiesel","msegas","msesmoker","msediesel")
for(i in 1:3)
{
pmfsim[1,i]<-facmeans[[i]]
}
pmfsim[,4]<-facmsemeans[1]
pmfsim[,5]<-facmsemeans[2]
pmfsim[,6]<-facmsemeans[3]
pmfsim
days<-50
ysims<-matrix(NA,93,days)
fpre<-matrix(NA,days,3)
cv<-.05
cvlog<-.05
fleet1profilesarr<-array(NA,dim=c(93,3,days))
fleet1VAarr<-array(NA,dim=c(93,3,days))
for(i in 1:days)
{
dataday<-datagen(cv,cvlog)
fleet1profilesarr[,,i]<-dataday[[3]]
fleet1VAarr[,,i]<-dataday[[4]]
fpre[i,]<-dataday[[2]][1,]
ysims[,i]<-dataday[[1]][,1]
}
cv<-.05
iter<-50
fac1<-matrix(NA,50,3)
for(t in 1:iter)
{
fpre1<-fpre[t,]
yfleet1profiles1<-fleet1profilesarr[,,t]
yfleet1VA1<-fleet1VAarr[,,t]
ysimspmf<-ysims[,t]
pmf3run<-pmf3(cv)
fac1<-pmf3run[[1]]
facmse<-pmf3run[[2]]
}
facmeans<-apply(fac1,2,mean)
facmsemeans<-apply(facmse,2,mean)
pmfsim<-matrix(NA,1,6)
colnames(pmfsim)<-c("fgas","smoker","fdiesel","msegas","msesmoker","msediesel")
for(i in 1:3)
{
pmfsim[1,i]<-facmeans[[i]]
}
pmfsim[,4]<-facmsemeans[1]
pmfsim[,5]<-facmsemeans[2]
pmfsim[,6]<-facmsemeans[3]
pmfsim
